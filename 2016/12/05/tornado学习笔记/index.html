<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <link rel="dns-prefetch" href="http://liuchao.site">
  <title>tornado源码学习笔记 | Fantasy的个人博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="yield用法   在python中，如果一个函数里面含有yield语句，那么调用函数，返回的不是函数的return结果，而是一个生成器。之后进行操作能将这个函数返回中间结果给调用者，然后维护函数的局部状态，所以当函数离开时，也能恢复执行。来看一个例子：
123456def fib(n_max):    n,a,b = 0,0,1    while n&amp;lt;n_max:        yield">
<meta property="og:type" content="article">
<meta property="og:title" content="tornado源码学习笔记">
<meta property="og:url" content="http://liuchao.site/2016/12/05/tornado学习笔记/index.html">
<meta property="og:site_name" content="Fantasy的个人博客">
<meta property="og:description" content="yield用法   在python中，如果一个函数里面含有yield语句，那么调用函数，返回的不是函数的return结果，而是一个生成器。之后进行操作能将这个函数返回中间结果给调用者，然后维护函数的局部状态，所以当函数离开时，也能恢复执行。来看一个例子：
123456def fib(n_max):    n,a,b = 0,0,1    while n&amp;lt;n_max:        yield">
<meta property="og:updated_time" content="2016-12-20T05:40:39.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="tornado源码学习笔记">
<meta name="twitter:description" content="yield用法   在python中，如果一个函数里面含有yield语句，那么调用函数，返回的不是函数的return结果，而是一个生成器。之后进行操作能将这个函数返回中间结果给调用者，然后维护函数的局部状态，所以当函数离开时，也能恢复执行。来看一个例子：
123456def fib(n_max):    n,a,b = 0,0,1    while n&amp;lt;n_max:        yield">
  
    <link rel="alternative" href="/atom.xml" title="Fantasy的个人博客" type="application/atom+xml">
  
  
  <link rel="stylesheet" href="/main.css">
  

</head>

<body>
  <div id="container" v-bind:class="{ show: isCtnShow }">
    <canvas id="anm-canvas" class="anm-canvas"></canvas>
    <div class="left-col" v-bind:class="{ show: isShow }">
      <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img src="http://7xn3wd.com1.z0.glb.clouddn.com/52d8c966e1d74080.jpg" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">Fantasy</a></h1>
		</hgroup>

		

		<nav class="header-menu">
			<ul>
			
				<li><a href="/">主页</a></li>
	        
				<li><a href="/tags/program">编程</a></li>
	        
				<li><a href="/tags/lifenote">随笔</a></li>
	        
			</ul>
		</nav>
		<nav class="header-smart-menu">
	        
    		
    			
    			<a data-idx="0" v-on:click="openSlider($event, 'innerArchive')" href="javascript:void(0)">所有文章</a>
    			
    			
            
    			
    			<a data-idx="1" v-on:click="openSlider($event, 'aboutme')" href="javascript:void(0)">关于我</a>
    			
    			
            
		</nav>
		<nav class="header-nav">
			<div class="social">
				
					<a class="github" target="_blank" href="https://github.com/liuchaopy" title="github"><i class="icon-github"></i></a>
		        
					<a class="weibo" target="_blank" href="http://weibo.com/fantasy824" title="weibo"><i class="icon-weibo"></i></a>
		        
					<a class="zhihu" target="_blank" href="https://www.zhihu.com/people/liuchaopy/activities" title="zhihu"><i class="icon-zhihu"></i></a>
		        
					<a class="douban" target="_blank" href="https://www.douban.com/people/103793003/" title="douban"><i class="icon-douban"></i></a>
		        
			</div>
		</nav>
	</header>		
</div>

    </div>
    <div class="mid-col" v-bind:class="{ show: isShow, hide: isShow === false }">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"><i class="icon-sort"></i></div>
  		<h1 class="header-author js-mobile-header hide">Fantasy</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				
					<img src="http://7xn3wd.com1.z0.glb.clouddn.com/52d8c966e1d74080.jpg" class="js-avatar">
				
			</div>
			<hgroup>
			  <h1 class="header-author">Fantasy</h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/tags/program">编程</a></li>
		        
					<li><a href="/tags/lifenote">随笔</a></li>
		        
		        
		        	<li><a href="/archives">所有文章</a></li>
		        
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/liuchaopy" title="github"><i class="icon-github"></i></a>
			        
						<a class="weibo" target="_blank" href="http://weibo.com/fantasy824" title="weibo"><i class="icon-weibo"></i></a>
			        
						<a class="zhihu" target="_blank" href="https://www.zhihu.com/people/liuchaopy/activities" title="zhihu"><i class="icon-zhihu"></i></a>
			        
						<a class="douban" target="_blank" href="https://www.douban.com/people/103793003/" title="douban"><i class="icon-douban"></i></a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div id="wrapper" class="body-wrap">
        <div class="menu-l">
          <div class="canvas-wrap">
            <canvas data-colors="#eaeaea" data-sectionHeight="100" data-contentId="js-content" id="myCanvas1" class="anm-canvas"></canvas>
          </div>
          <div id="js-content" class="content-ll">
            <article id="post-tornado学习笔记" class="article article-type-post " itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      tornado源码学习笔记
    </h1>
  

        <a href="/2016/12/05/tornado学习笔记/" class="archive-article-date">
  	<time datetime="2016-12-05T07:06:41.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2016-12-05</time>
</a>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="yield用法"><a href="#yield用法" class="headerlink" title="yield用法"></a>yield用法</h1><p>   在python中，如果一个函数里面含有yield语句，那么调用函数，返回的不是函数的return结果，而是一个生成器。之后进行操作能将这个函数返回中间结果给调用者，然后维护函数的局部状态，所以当函数离开时，也能恢复执行。来看一个例子：</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="symbol">def</span> fib(n_max):</div><div class="line">    n,a,<span class="keyword">b </span>= <span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span></div><div class="line">    <span class="meta">while</span> n&lt;n_max:</div><div class="line">        <span class="keyword">yield </span><span class="keyword">b</span></div><div class="line">        a,<span class="keyword">b </span>= <span class="keyword">b,a+b</span></div><div class="line">        n += <span class="number">1</span></div></pre></td></tr></table></figure>
<p>调用函数返回的是一个生成器</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">In</span> [<span class="number">53</span>]: fib(<span class="number">6</span>)</div><div class="line"><span class="keyword">Out</span>[<span class="number">53</span>]: &lt;generator object fib <span class="meta">at</span> <span class="number">0x103eb5640</span>&gt;</div></pre></td></tr></table></figure>
<p>想要得到结果，需要再次将其当做可迭代对象处理，例如使用for或多次使用next方法。<br><a id="more"></a><br>next和send方法</p>
<p>含yield语句的函数返回的是一个生成器类，这个生成器自带一个next方法，每次调用x.next()时，会执行函数类的代码，直到出现了yield，程序返回yield后面的结果。程序并挂起，直到下次调用next()，程序继续执行<br>。直到出现yield程序再次挂起。来看个例子吧。</p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">In</span> [<span class="number">55</span>]: def <span class="function"><span class="keyword">func</span><span class="params">()</span>:</span></div><div class="line">   ....:     print <span class="string">"aaaa"</span></div><div class="line">   ....:     yield <span class="number">1</span></div><div class="line">   ....:     print <span class="string">"bbbb"</span></div><div class="line">   ....:     yield <span class="number">2</span></div><div class="line">   ....:     print <span class="string">"cccc"</span></div><div class="line">   ....:     yield <span class="number">3</span></div><div class="line">   ....:</div><div class="line"></div><div class="line"><span class="keyword">In</span> [<span class="number">56</span>]: c = <span class="function"><span class="keyword">func</span><span class="params">()</span></span></div><div class="line"></div><div class="line"><span class="keyword">In</span> [<span class="number">57</span>]: c</div><div class="line">Out[<span class="number">57</span>]: &lt;generator object <span class="function"><span class="keyword">func</span> <span class="title">at</span> 0<span class="title">x103eb5690</span>&gt;</span></div><div class="line"></div><div class="line"><span class="keyword">In</span> [<span class="number">58</span>]: c.<span class="keyword">next</span>()</div><div class="line">aaaa</div><div class="line">Out[<span class="number">58</span>]: <span class="number">1</span></div><div class="line"></div><div class="line"><span class="keyword">In</span> [<span class="number">59</span>]: c.<span class="keyword">next</span>()</div><div class="line">bbbb</div><div class="line">Out[<span class="number">59</span>]: <span class="number">2</span></div><div class="line"></div><div class="line"><span class="keyword">In</span> [<span class="number">60</span>]: c.<span class="keyword">next</span>()</div><div class="line">cccc</div><div class="line">Out[<span class="number">60</span>]: <span class="number">3</span></div><div class="line"></div><div class="line"><span class="keyword">In</span> [<span class="number">61</span>]: c.<span class="keyword">next</span>()</div><div class="line">---------------------------------------------------------------------------</div><div class="line">StopIteration                             Traceback (most recent <span class="built_in">call</span> last)</div><div class="line">&lt;ipython-input<span class="number">-61</span><span class="number">-50</span>b4dad19337&gt; <span class="keyword">in</span> &lt;module&gt;()</div><div class="line">----&gt; <span class="number">1</span> c.<span class="keyword">next</span>()</div><div class="line"></div><div class="line">StopIteration:</div></pre></td></tr></table></figure>
<p>如果我们将yield看做表达式，并赋值给一个变量，那这个变量的得到的是什么呢。就像这样：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">print</span> <span class="string">"start"</span></div><div class="line">    a = <span class="keyword">yield</span> <span class="number">1</span></div><div class="line">    <span class="keyword">print</span> <span class="string">"a:"</span>, a</div><div class="line">    b = <span class="keyword">yield</span> <span class="number">2</span></div><div class="line">    <span class="keyword">print</span> <span class="string">"b:"</span>, b</div></pre></td></tr></table></figure>
<p>这里a得到的并不是1，b并不是2.</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">In</span> <span class="selector-attr">[69]</span>: <span class="selector-tag">c</span><span class="selector-class">.next</span>()</div><div class="line"><span class="selector-tag">start</span></div><div class="line"><span class="selector-tag">Out</span><span class="selector-attr">[69]</span>: 1</div><div class="line"></div><div class="line"><span class="selector-tag">In</span> <span class="selector-attr">[70]</span>: <span class="selector-tag">c</span><span class="selector-class">.next</span>()</div><div class="line"><span class="selector-tag">a</span>: <span class="selector-tag">None</span></div><div class="line"><span class="selector-tag">Out</span><span class="selector-attr">[70]</span>: 2</div><div class="line"></div><div class="line"><span class="selector-tag">In</span> <span class="selector-attr">[71]</span>: <span class="selector-tag">c</span><span class="selector-class">.next</span>()</div><div class="line"><span class="selector-tag">b</span>: <span class="selector-tag">None</span></div></pre></td></tr></table></figure>
<p>next方法返回的才是yield后面的内容，a,b得到的是None。生成器里面还有一个函数是send函数，<br>调用send函数也有next函数的效果，或者其实说c.next()相当于调用c.send(None)。a,b得到的None就来自send的值。再看：</p>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">In</span> [<span class="number">79</span>]: c = func()</div><div class="line"></div><div class="line"><span class="keyword">In</span> [<span class="number">80</span>]: r = c.next()</div><div class="line">start</div><div class="line"></div><div class="line"><span class="keyword">In</span> [<span class="number">81</span>]: r</div><div class="line"><span class="keyword">Out</span>[<span class="number">81</span>]: <span class="number">1</span></div><div class="line"></div><div class="line"><span class="keyword">In</span> [<span class="number">82</span>]: <span class="built_in">r2</span> = c.send(<span class="string">"lalala"</span>)</div><div class="line"><span class="symbol">a:</span> lalala</div><div class="line"></div><div class="line"><span class="keyword">In</span> [<span class="number">83</span>]: <span class="built_in">r2</span></div><div class="line"><span class="keyword">Out</span>[<span class="number">83</span>]: <span class="number">2</span></div><div class="line"></div><div class="line"><span class="keyword">In</span> [<span class="number">84</span>]: <span class="built_in">r3</span> = c.send(<span class="string">"hahaha"</span>)</div><div class="line"><span class="symbol">b:</span> hahaha</div></pre></td></tr></table></figure>
<p>注意第一次调用调用的是send(None)或next().可以看出send方法返回的是yield后面的东西，而yield赋值给的变量a,b得到的是send函数里面的内容。<br>正式yield的这种特性可以用来实现协程，程序在某个时刻通过yield挂起当前函数，切换到其他地方运行代码，再在某个时刻调用send()。程序继续执行。例如我们有一个比较耗时的io操作,可以通过yield切换到其他程序继续执行，当io操作好了的时候，通过send通知函数继续执行，程序不会阻塞在io操作上。tornado也是借助这种方式来实现协程进行异步操作。</p>
<h1 id="Future类分析"><a href="#Future类分析" class="headerlink" title="Future类分析"></a>Future类分析</h1><p>Future类是tornado一个特别重要的类，tornado借助Future类保存程序异步的结果。这个结果包括返回值，异常信息，回调函数。例如刚才遇到耗时io操作时，将耗时操作包括回调等封装Future中，然后通过yield返回。通过ioloop来异步处理，最后调用Future的set_result将io操作结果放入Future中。来看看主要源码及它拥有的属性和方法吧</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Future</span><span class="params">(object)</span>:</span></div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        self._done = <span class="keyword">False</span></div><div class="line">        self._result = <span class="keyword">None</span></div><div class="line">        self._exc_info = <span class="keyword">None</span></div><div class="line">        self._callbacks = []</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">running</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="string">"""Returns True if this operation is currently running."""</span></div><div class="line">        <span class="keyword">return</span> <span class="keyword">not</span> self._done</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">done</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="string">"""Returns True if the future has finished running."""</span></div><div class="line">        <span class="keyword">return</span> self._done</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">result</span><span class="params">(self, timeout=None)</span>:</span></div><div class="line">        self._clear_tb_log()</div><div class="line">        <span class="keyword">if</span> self._result <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</div><div class="line">            <span class="keyword">return</span> self._result</div><div class="line">        <span class="keyword">if</span> self._exc_info <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</div><div class="line">            raise_exc_info(self._exc_info)</div><div class="line">        self._check_done()</div><div class="line">        <span class="keyword">return</span> self._result</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">exception</span><span class="params">(self, timeout=None)</span>:</span></div><div class="line">        <span class="string">"""</span></div><div class="line">        返回异常信息</div><div class="line">        """</div><div class="line">        self._clear_tb_log()</div><div class="line">        <span class="keyword">if</span> self._exc_info <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</div><div class="line">            <span class="keyword">return</span> self._exc_info[<span class="number">1</span>]</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            self._check_done()</div><div class="line">            <span class="keyword">return</span> <span class="keyword">None</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add_done_callback</span><span class="params">(self, fn)</span>:</span></div><div class="line">        <span class="keyword">if</span> self._done:</div><div class="line">            fn(self)</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            self._callbacks.append(fn)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set_result</span><span class="params">(self, result)</span>:</span></div><div class="line">        <span class="string">"""Sets the result of a ``Future``.</span></div><div class="line"></div><div class="line">        It is undefined to call any of the ``set`` methods more than once</div><div class="line">        on the same object.</div><div class="line">        """</div><div class="line">        self._result = result</div><div class="line">        self._set_done()</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set_exception</span><span class="params">(self, exception)</span>:</span></div><div class="line">        <span class="string">"""Sets the exception of a ``Future.``"""</span></div><div class="line">        self.set_exc_info(</div><div class="line">            (exception.__class__,</div><div class="line">             exception,</div><div class="line">             getattr(exception, <span class="string">'__traceback__'</span>, <span class="keyword">None</span>)))</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">exc_info</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="string">"""省略"""</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set_exc_info</span><span class="params">(self, exc_info)</span>:</span></div><div class="line">        <span class="string">"""省略"""</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_check_done</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self._done:</div><div class="line">            <span class="keyword">raise</span> Exception(<span class="string">"DummyFuture does not support blocking for results"</span>)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_set_done</span><span class="params">(self)</span>:</span></div><div class="line">        self._done = <span class="keyword">True</span></div><div class="line">        <span class="keyword">for</span> cb <span class="keyword">in</span> self._callbacks:</div><div class="line">            <span class="keyword">try</span>:</div><div class="line">                cb(self)</div><div class="line">            <span class="keyword">except</span> Exception:</div><div class="line">                app_log.exception(<span class="string">'Exception in callback %r for %r'</span>,</div><div class="line">                                  cb, self)</div><div class="line">        self._callbacks = <span class="keyword">None</span></div></pre></td></tr></table></figure>
<p><code>running()</code>方法获取Future是否处理完得到result。如果得到返回False，没有表示还在运行，返回True.</p>
<p><code>done()</code>正好和<code>running</code>方法相反</p>
<p><code>result()</code>获取Future处理完的结果，如果没有处理完，则会跑出一个<code>DummyFuture does not support blocking for results</code>的异常</p>
<p><code>add_done_callback(fn)</code> 将回调函数添加到Future对象中,如果Future已经处理完，则直接执行fn，否则将fn添加到回调函数列表中，之后在执行</p>
<p><code>set_result</code>将结果赋值给Future对象，并调用_set_done()执行回调函数</p>
<p><code>_check_done</code>检查Future是否执行完得到结果，没有则跑出异常</p>
<p><code>_set_done</code>设置Future为处理完，并执行回调函数列表中的函数。</p>
<p>Future是沟通gen模块和ioloop模块的一座桥梁。将yield语句返回的对象封装后交给ioloop去调度处理。</p>
<h1 id="epoll理解"><a href="#epoll理解" class="headerlink" title="epoll理解"></a>epoll理解</h1><p>epoll是对select和poll的改进版本。相对于多进程和多线程技术来说，这种I/O多路复用技术最大的优势就是减少了系统开销，通过监听等待文件操作符是否就绪，如果就绪，进程将所读数据复制到应用进程缓存区进行处理，不需要创建进程和线程，也不必维护这些进程线程。等待就绪，初步看有些像多线程中的阻塞io,但select等函数可以同时监听等待多个文件描述符，性能就大大提升啦。相对于select和poll。epoll的优点是没有监听的文件描述符的限制。且select和poll需要不断轮询所有fd(文件描述符）集合，直到设备就绪。epoll则是设备就绪时，调用回调函数，将就绪fd放入就绪表中，之后只要判断就绪表是不是为空就行啦。<br>在Linux下系统实现了epoll模型，其他平台类似的是kqueue。</p>
<p>Python中epoll封装在select模块中。来看个简单的使用例子，</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line">import socket</div><div class="line">import select</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">EpollServer</span>(<span class="title">object</span>):</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(<span class="keyword">self</span>, host=<span class="string">'localhost'</span>, port=<span class="number">8888</span>)</span></span>:</div><div class="line">        <span class="keyword">self</span>.sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</div><div class="line">        <span class="keyword">self</span>.sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="number">1</span>) <span class="comment">#设置地址可重用</span></div><div class="line">        <span class="keyword">self</span>.sock.bind((host, port))</div><div class="line">        <span class="keyword">self</span>.sock.listen(<span class="number">1</span>)</div><div class="line">        <span class="keyword">self</span>.sock.setblocking(<span class="number">0</span>)   <span class="comment">#设置非阻塞</span></div><div class="line"></div><div class="line">        <span class="keyword">self</span>.epoll = select.epoll()</div><div class="line">        <span class="keyword">self</span>.epoll.register(<span class="keyword">self</span>.sock.fileno(), select.EPOLLIN)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(<span class="keyword">self</span>)</span></span>:</div><div class="line">        <span class="symbol">try:</span></div><div class="line">            conns = &#123;&#125;</div><div class="line">            reqs = &#123;&#125;</div><div class="line">            resps = &#123;&#125;</div><div class="line">            <span class="keyword">while</span> <span class="symbol">True:</span></div><div class="line">                events = <span class="keyword">self</span>.epoll.poll(<span class="number">1</span>)</div><div class="line">                <span class="keyword">for</span> fileno, event <span class="keyword">in</span> <span class="symbol">events:</span></div><div class="line">                    <span class="keyword">if</span> fileno == <span class="keyword">self</span>.sock.fileno():</div><div class="line">                        conn,addr = <span class="keyword">self</span>.sock.accept()</div><div class="line">                        conn_fileno = conn.fileno()</div><div class="line">                        conn.setblocking(<span class="number">0</span>)</div><div class="line">                        <span class="keyword">self</span>.epoll.register(conn.fileno, select.EPOLLIN)</div><div class="line">                        conns[conn_fileno] = conn</div><div class="line">                        reqs[conn_fileno] = b<span class="string">''</span></div><div class="line">                        resps[conn_fileno] =  b<span class="string">""</span><span class="string">"HTTP/1.0 200 OK\r\nDate: Mon, 1 Jan 1996 01:01:01 GMT\r\n</span></div><div class="line">                        Content-Type: text/plain\r\nContent-Length: 13\r\n\r\nHello, world!"<span class="string">""</span></div><div class="line">                    elif event &amp; select.<span class="symbol">EPOLLIN:</span></div><div class="line">                        reqs[fileno]+=conns[fileno].recv(<span class="number">1024</span>)</div><div class="line">                        <span class="keyword">if</span> b<span class="string">'\n\n'</span> <span class="keyword">in</span> reqs[fileno] <span class="keyword">or</span> b<span class="string">'\n\r\n'</span> <span class="keyword">in</span> reqs[fileno]:</div><div class="line">                            <span class="keyword">self</span>.epoll.modify(fileno, select.EPOLLOUT)</div><div class="line">                            print(reqs[fileno].decode())</div><div class="line">                    elif event &amp; select.<span class="symbol">EPOLLOUT:</span></div><div class="line">                        len_write = conns[fileno].send(resps[fileno])</div><div class="line">                        resps[fileno] = resps[fileno][<span class="symbol">len_write:</span>]</div><div class="line">                        <span class="keyword">if</span> len(resps[fileno]) == <span class="number">0</span>:</div><div class="line">                            <span class="keyword">self</span>.epoll.modify(fileno, <span class="number">0</span>)</div><div class="line">                            conns[fileno].shutdown(socket.SHUT_RDWR)</div><div class="line">                    elif event &amp; select.<span class="symbol">EPOLLHUB:</span></div><div class="line">                        <span class="keyword">self</span>.epoll.unregister(fileno)</div><div class="line">                        conns[fileno].close()</div><div class="line">                        del conns[fileno]</div><div class="line"></div><div class="line">        <span class="symbol">finally:</span></div><div class="line">            <span class="keyword">self</span>.epoll.unregister(<span class="keyword">self</span>.sock.fileno())</div><div class="line">            <span class="keyword">self</span>.epoll.close()</div><div class="line">            <span class="keyword">self</span>.sock.close()</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name_<span class="number">_</span> == <span class="string">'__main__'</span>:</div><div class="line">    epoll_server = EpollServer()</div><div class="line">    epoll_server.run()</div></pre></td></tr></table></figure>
<p>程序摘自《Python网络编程攻略》。调用select.epoll()实例化后，通过register函数来登记一个监听的文件描述符和事件。进入while循环，poll()方法返回监听到的事件event和文件描述符列表。</p>
<p>如果是服务器socket事件，建立连接，设置非阻塞，添加监听读事件。</p>
<p>如果事件event是可读，则读取数据，某个请求读完后，更新(调用modify)监听事件为监听是否可写。</p>
<p>如果事件event是可写，发送需要响应回的数据，发送完后,更改监听事件，</p>
<p>如果文件描述符被挂断， 调用unregister不再监听此文件描述符，关闭socket连接，并删除。</p>
<p>主要的几个方法就是<code>poll</code>,<code>register</code>,<code>modify</code>,<code>unregister</code>,<code>close</code>。</p>
<p>tornado在linux下是通过epoll来实现I/O多路复用。对io事件进行监听，ioloop</p>
<h1 id="ioloop模块分析"><a href="#ioloop模块分析" class="headerlink" title="ioloop模块分析"></a>ioloop模块分析</h1><p>ioloop是tornado底层的核心，主要调度处理io读写错误事件以及回调和超时等任务。当程序碰到yield切换时，便将yield后面的Future交给iooop调度处理，程序切换执行其他代码。</p>
<p><code>Configurable</code>类</p>
<p>   ioloop模块中，重要的是<code>IOLoop</code>类，它继承自<code>Configurable</code>类，<code>Configurable</code>是个抽象类，它负责让IOLoop实例化对象时，会根据不同的平台，实例成不同的对象，例如Linux实例化之后就可以调用EPollIOLoop类的所有方法。正如我们一般通过<code>tornado.ioloop.IOLoop.instance().start()</code>来启动IOLoop,但其实在Linux下，启动的是EpollIOLoop<br>实例，执行的也是里面的方法。看看源码可能清晰许多</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">def __new__(cls, *args, **kwargs):</div><div class="line">    base = cls.configurable_base()</div><div class="line">    init_kwargs = &#123;&#125;</div><div class="line">    <span class="keyword">if</span> cls is base:</div><div class="line">        impl = cls.configured_class()</div><div class="line">        <span class="keyword">if</span> base.__impl_kwargs:</div><div class="line">            init_kwargs.update(base.__impl_kwargs)</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        impl = cls</div><div class="line">    init_kwargs.update(kwargs)</div><div class="line">    instance = <span class="keyword">super</span>(Configurable, cls).__new__(impl)</div><div class="line">    # initialize vs __init__ chosen <span class="keyword">for</span> compatibility with AsyncHTTPClient</div><div class="line">    # singleton magic.  If we get rid of that we can <span class="keyword">switch</span> to __init__</div><div class="line">    # here too.</div><div class="line">    instance.initialize(*args, **init_kwargs)</div><div class="line">    <span class="keyword">return</span> instance</div></pre></td></tr></table></figure>
<p>在Linux平台下，<code>configurable_base()</code>返回一个IOLoop类,<code>configured_class()</code>返回的是<code>EPollIOLoop</code>类。继承了<code>Configurable</code>类的类实例化时，返回的实例在Linux下其实是一个EPollIOLoop实例，同理，如果系统使用的是kqueue，实例则是一个<code>KQueueIOLoop</code>实例</p>
<p>IOLoop类</p>
<p>IOloop比较复杂，主要负责调度。通过源码来看看一些常见的方法。我们通常调用<code>tornado.ioloop.IOLoop.current().start()</code><br>来启动实例，current()会判断当前有没有实例instance，如果没有，则调用<code>instance()</code>方法创建一个实例。<code>instance()</code>采用了单例模式，即使多次调用，创建的也是同一个全局IOLoop实例。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@staticmethod</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">instance</span><span class="params">()</span>:</span></div><div class="line">    <span class="string">"""Returns a global `IOLoop` instance.</span></div><div class="line">    """</div><div class="line">    <span class="keyword">if</span> <span class="keyword">not</span> hasattr(IOLoop, <span class="string">"_instance"</span>):</div><div class="line">        <span class="keyword">with</span> IOLoop._instance_lock:</div><div class="line">            <span class="keyword">if</span> <span class="keyword">not</span> hasattr(IOLoop, <span class="string">"_instance"</span>):</div><div class="line">                <span class="comment"># New instance after double check</span></div><div class="line">                IOLoop._instance = IOLoop()</div><div class="line">    <span class="keyword">return</span> IOLoop._instance</div></pre></td></tr></table></figure>
<p>实例创建后，需要通过<code>start()</code>方法来启动。这个方法实现在子类<code>PollIOLoop</code>类中。也是这个模块中最复杂的一个函数。<br>来看主要代码:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">    <span class="comment">#获取锁，然后将回调函数列表清空</span></div><div class="line">    with <span class="keyword">self</span>._callback_lock:</div><div class="line">        callbacks = <span class="keyword">self</span>._callbacks</div><div class="line">        <span class="keyword">self</span>._callbacks = []</div><div class="line"></div><div class="line">    due_timeouts = []</div><div class="line">    <span class="comment">#如果有超时任务,且已经超时，处理超时任务。还未超时，添加到due_timeouts列表中.</span></div><div class="line">    <span class="keyword">if</span> <span class="keyword">self</span>._timeouts:</div><div class="line">        now = <span class="keyword">self</span>.time()</div><div class="line">        <span class="keyword">while</span> <span class="keyword">self</span>._timeouts:</div><div class="line">            <span class="keyword">if</span> <span class="keyword">self</span>._timeouts[<span class="number">0</span>].callback is None:</div><div class="line">                <span class="comment"># The timeout was cancelled.  Note that the</span></div><div class="line">                <span class="comment"># cancellation check is repeated below for timeouts</span></div><div class="line">                <span class="comment"># that are cancelled by another timeout or callback.</span></div><div class="line">                heapq.heappop(<span class="keyword">self</span>._timeouts)</div><div class="line">                <span class="keyword">self</span>._cancellations -= <span class="number">1</span></div><div class="line">            elif <span class="keyword">self</span>._timeouts[<span class="number">0</span>].deadline &lt;= now:</div><div class="line">                due_timeouts.append(heapq.heappop(<span class="keyword">self</span>._timeouts))</div><div class="line">            <span class="keyword">else</span>:</div><div class="line">                <span class="keyword">break</span></div><div class="line">        <span class="keyword">if</span> (<span class="keyword">self</span>._cancellations &gt; <span class="number">512</span> <span class="keyword">and</span></div><div class="line">                    <span class="keyword">self</span>._cancellations &gt; (len(<span class="keyword">self</span>._timeouts) &gt;&gt; <span class="number">1</span>)):</div><div class="line">            <span class="comment"># Clean up the timeout queue when it gets large and it's</span></div><div class="line">            <span class="comment"># more than half cancellations.</span></div><div class="line">            <span class="keyword">self</span>._cancellations = <span class="number">0</span></div><div class="line">            <span class="keyword">self</span>._timeouts = [x <span class="keyword">for</span> x in <span class="keyword">self</span>._timeouts</div><div class="line">                              <span class="keyword">if</span> x.callback is not None]</div><div class="line">            heapq.heapify(<span class="keyword">self</span>._timeouts)</div><div class="line"></div><div class="line">    <span class="comment">#处理回调函数</span></div><div class="line">    <span class="keyword">for</span> callback in callbacks:</div><div class="line">        <span class="keyword">self</span>._run_callback(callback)</div><div class="line">    <span class="comment">#处理快要超时的超时任务</span></div><div class="line">    <span class="keyword">for</span> timeout in due_timeouts:</div><div class="line">        <span class="keyword">if</span> timeout.callback is not None:</div><div class="line">            <span class="keyword">self</span>._run_callback(timeout.callback)</div><div class="line">    <span class="comment"># Closures may be holding on to a lot of memory, so allow</span></div><div class="line">    <span class="comment"># them to be freed before we go into our poll wait.</span></div><div class="line">    </div><div class="line">    callbacks = callback = due_timeouts = timeout = None</div><div class="line">    </div><div class="line">    <span class="comment">#如果刚清空的_callbacks又有回调任务或超时回调任务添加进来，调用他们之前不在poll(poll_timeout)中等待下一次轮询</span></div><div class="line">    <span class="keyword">if</span> <span class="keyword">self</span>._callbacks:</div><div class="line">        poll_timeout = <span class="number">0.0</span></div><div class="line">    elif <span class="keyword">self</span>._timeouts:</div><div class="line">        <span class="comment"># If there are any timeouts, schedule the first one.</span></div><div class="line">        <span class="comment"># Use self.time() instead of 'now' to account for time</span></div><div class="line">        <span class="comment"># spent running callbacks.</span></div><div class="line">        poll_timeout = <span class="keyword">self</span>._timeouts[<span class="number">0</span>].deadline - <span class="keyword">self</span>.time()</div><div class="line">        poll_timeout = max(<span class="number">0</span>, min(poll_timeout, _POLL_TIMEOUT))</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        <span class="comment"># No timeouts and no callbacks, so use the default.</span></div><div class="line">        poll_timeout = _POLL_TIMEOUT</div><div class="line"></div><div class="line">    <span class="keyword">if</span> not <span class="keyword">self</span>._running:</div><div class="line">        <span class="keyword">break</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> <span class="keyword">self</span>._blocking_signal_threshold is not None:</div><div class="line">        <span class="comment"># clear alarm so it doesn't fire while poll is waiting for</span></div><div class="line">        <span class="comment"># events.</span></div><div class="line">        signal.setitimer(signal.ITIMER_REAL, <span class="number">0</span>, <span class="number">0</span>)</div><div class="line"></div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        <span class="comment">#开始监听事件</span></div><div class="line">        event_pairs = <span class="keyword">self</span>._impl.poll(poll_timeout)</div><div class="line">    except <span class="keyword">Exception</span> <span class="keyword">as</span> e:</div><div class="line">        <span class="keyword">if</span> errno_from_exception(e) == errno.EINTR:</div><div class="line">            <span class="keyword">continue</span></div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            raise</div><div class="line"></div><div class="line">    <span class="keyword">self</span>._events.update(event_pairs)</div><div class="line">    如果监听到事件，处理事件</div><div class="line">    <span class="keyword">while</span> <span class="keyword">self</span>._events:</div><div class="line">        fd, events = <span class="keyword">self</span>._events.popitem()</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            fd_obj, handler_func = <span class="keyword">self</span>._handlers[fd]</div><div class="line">            handler_func(fd_obj, events)</div><div class="line">        except (OSError, IOError) <span class="keyword">as</span> e:</div><div class="line">            <span class="keyword">if</span> errno_from_exception(e) == errno.EPIPE:</div><div class="line">                <span class="comment"># Happens when the client closes the connection</span></div><div class="line">                pass</div><div class="line">            <span class="keyword">else</span>:</div><div class="line">                <span class="keyword">self</span>.handle_callback_exception(<span class="keyword">self</span>._handlers.get(fd))</div><div class="line">        except <span class="keyword">Exception</span>:</div><div class="line">            <span class="keyword">self</span>.handle_callback_exception(<span class="keyword">self</span>._handlers.get(fd))</div><div class="line">    fd_obj = handler_func = None</div></pre></td></tr></table></figure>
<p>主要做的就是监听事件，处理事件，以及处理回调函数以及超时回调函数，注意这里的超时回调函数表是一个最小堆，根据需要在某个时刻执行根据时间对成了堆，每次从堆中拿出来的第一个任务就是离现在最近的任务，从而实现延时处理的效果。</p>
<p>接下来来看几个重要的函数:</p>
<p><code>add_handler(fd,handler,events)</code>函数</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_handler</span><span class="params">(<span class="keyword">self</span>, fd, handler, events)</span></span>:</div><div class="line">    fd, obj = <span class="keyword">self</span>.split_fd(fd)</div><div class="line">    <span class="keyword">self</span>._handlers[fd] = (obj, stack_context.wrap(handler))</div><div class="line">    <span class="keyword">self</span>._impl.register(fd, events <span class="params">| <span class="keyword">self</span>.ERROR)</span></div></pre></td></tr></table></figure>
<p>fd为一个文件操作符，handler为一个处理函数，events为io事件，这个函数使用epoll登记监听fd上的events，当事件发生时，调用handler(fd,events处理事件)</p>
<p><code>add_timeout(deadline,callback,*args,**kwargs)</code>函数。在deadline的时候调用callback函数。这个函数调用的是实现在PollIOLoop类中的call_at函数，call_at函数会将任务封装后添加到start()中看到过的self._timeouts堆中。</p>
<p><code>add_callback(callback,*args,**kwargs)</code>函数,也是在PollIOLoop中实现</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_callback</span><span class="params">(<span class="keyword">self</span>, callback, *args, **kwargs)</span></span>:</div><div class="line">    <span class="keyword">if</span> thread.get_ident() != <span class="keyword">self</span>.<span class="symbol">_thread_ident:</span></div><div class="line">        with <span class="keyword">self</span>.<span class="symbol">_callback_lock:</span></div><div class="line">            <span class="keyword">if</span> <span class="keyword">self</span>.<span class="symbol">_closing:</span></div><div class="line">                <span class="keyword">return</span></div><div class="line">            list_empty = <span class="keyword">not</span> <span class="keyword">self</span>._callbacks</div><div class="line">            <span class="keyword">self</span>._callbacks.append(functools.partial(</div><div class="line">                stack_context.wrap(callback), *args, **kwargs))</div><div class="line">            <span class="keyword">if</span> <span class="symbol">list_empty:</span></div><div class="line">                <span class="keyword">self</span>._waker.wake()</div><div class="line">    <span class="symbol">else:</span></div><div class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.<span class="symbol">_closing:</span></div><div class="line">            <span class="keyword">return</span></div><div class="line">        <span class="keyword">self</span>._callbacks.append(functools.partial(</div><div class="line">            stack_context.wrap(callback), *args, **kwargs)</div></pre></td></tr></table></figure>
<p>也是在PollIOLoop中实现，将任务通过偏函数包装后，添加到回调函数列表中。在之后的循环中处理。</p>
<p><code>add_future(future,callback)</code>函数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_future</span><span class="params">(self, future, callback)</span>:</span></div><div class="line">    <span class="string">"""Schedules a callback on the ``IOLoop`` when the given</span></div><div class="line">    `.Future` is finished.</div><div class="line"></div><div class="line">    The callback is invoked with one argument, the</div><div class="line">    `.Future`.</div><div class="line">    """</div><div class="line">    <span class="keyword">assert</span> is_future(future)</div><div class="line">    callback = stack_context.wrap(callback)</div><div class="line">    future.add_done_callback(</div><div class="line">        <span class="keyword">lambda</span> future: self.add_callback(callback, future))</div></pre></td></tr></table></figure>
<p>添加一个callback函数到Future对象中，当Future对象被set_result,执行一个回调函数，即这个lambda函数，在lambda函数中调用IOLoop的add_callback函数。将add_future的参数callback加入到IOLoop的统一调度中，让callback在IOLoop下一次迭代中执行。</p>
<p><code>run_sync(func,timeout=None)</code>函数</p>
<h1 id="iostream模块分析"><a href="#iostream模块分析" class="headerlink" title="iostream模块分析"></a>iostream模块分析</h1><p>iostream模块中IOStream主要是对socket读写进行封装。类初始化时，会绑定一个socket，绑定一个ioloop。<br>然后分别创建一个读缓冲区_read_buffer和一个写缓冲区_write_buffer。这两个缓存区都是collections.deque()双端队列类型。</p>
<p>读写接口</p>
<p><code>read_until(delimiter,callback=None,max_bytes=None)</code>异步从缓冲区读取数据直到读取到了分隔符delimiter。如果有callback函数，读取到数据后执行回调函数，如果缓冲区没有数据，则需要先调用<code>_read_to_buffer()</code>从socket读取数据，然后将数据写入buffer中。如果max_bytes给了，如果没有碰到delimiter，则会一直读取数据，超过max_bytes后会关闭连接。</p>
<p><code>read_until_regex(regex,callback=None,max_bytes=None)</code>和read_until类似，不同的是将delimiter换成了一个正则表达式，从缓冲区读取数据直到读取到的数据满足正则表达式</p>
<p><code>read_bytes(num_bytes, callback=None, streaming_callback=None,partial=False)</code>异步读取长度为num_bytes的数据。</p>
<p><code>read_until_close(callback=None, streaming_callback=None)</code> 异步读取数据直到socket关闭</p>
<p><code>write(data,callback=None)</code> 将数据写入缓存区中。</p>
<p>几个主要的内部函数：</p>
<p><code>write_to_fd(data)</code> 将数据写入socket中，发送出去</p>
<p><code>read_from_fd</code> 从socket读取数据</p>
<p><code>_read_to_buffer</code> 读取socket的数据并添加到缓冲区buffer中。</p>
<p><code>_read_from_buffer</code>从buffer中读取数据</p>
<p><code>_try_inline_read()</code>试着从buffer读取数据，如果数据没有或不够，则开始监听socket，读取新的数据</p>
<p><code>_add_io_state(state)</code> 在ioloop中注册事件状态，调用的是ioloop的add_handler函数，监听socket，当满足state状态时，调用self._handle_events处理事件。</p>
<p>还有一个比较有意思额的函数是<code>_consume(loc)</code>，他能将缓冲区的前loc个数据合并，例如<code>[&#39;abc&#39;,&#39;de&#39;,&#39;fgh&#39;,&#39;i&#39;]</code>合并前6个数据后变成了<code>[&#39;abcdef&#39;,&#39;gh&#39;,&#39;i&#39;]</code>然后调用popleft()返回这loc字节数据</p>
<h1 id="gen-coroutine装饰器分析"><a href="#gen-coroutine装饰器分析" class="headerlink" title="gen.coroutine装饰器分析"></a>gen.coroutine装饰器分析</h1><p>coroutine装饰器主要作用是将，本来需要异步回调写的代码，看起来像是在写同步函数。例如抓取一个网页，回调写法是:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> tornado.httpclient <span class="keyword">import</span> AsyncHTTPClient</div><div class="line"><span class="keyword">import</span> tornado.ioloop</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">callback</span><span class="params">(response)</span>:</span></div><div class="line">	do_something(response)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">asychronous_fetch</span><span class="params">(url, callback)</span>:</span></div><div class="line">	httpclient = AsyncHTTPClient()</div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">handle_response</span><span class="params">(response)</span>:</span></div><div class="line">		callback(response.body)</div><div class="line"></div><div class="line">	httpclient.fetch(url,callback=handle_response)</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">	url = <span class="string">'http://www.baidu.com'</span></div><div class="line">	asychronous_fetch(url, callback)</div><div class="line">	tornado.ioloop.IOLoop.instance().start()</div></pre></td></tr></table></figure>
<p>通过coroutine装饰器，代码写起来是这样的</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> tornado <span class="keyword">import</span> gen</div><div class="line"><span class="keyword">from</span> tornado.httpclient <span class="keyword">import</span> AsyncHTTPClient</div><div class="line"><span class="keyword">import</span> tornado</div><div class="line"></div><div class="line">url = <span class="string">'http://www.baidu.com'</span></div><div class="line"></div><div class="line"><span class="meta">@gen.coroutine</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">fetch_cor</span><span class="params">(url)</span>:</span></div><div class="line">	http_client = AsyncHTTPClient()</div><div class="line">	response = <span class="keyword">yield</span> http_client.fetch(url)</div><div class="line">	do_something(response.body)</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">	fetch_cor(url)</div><div class="line">	tornado.ioloop.IOLoop.instance().start()</div></pre></td></tr></table></figure>
<p>直接调用函数返回的是一个生成器，装饰器调用next()，遇到yield挂起，装饰器将yield后面的对象进行异步处理，处理完之后将结果通过send发送回来，也就被response接收。看起来像是同步的代码进行的是异步处理。</p>
<p>装饰器主要源码:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">_make_coroutine_wrapper</span><span class="params">(func, replace_callback)</span>:</span></div><div class="line">    <span class="keyword">if</span> hasattr(types, <span class="string">'coroutine'</span>):</div><div class="line">        func = types.coroutine(func)</div><div class="line"></div><div class="line"><span class="meta">    @functools.wraps(func)</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args, **kwargs)</span>:</span></div><div class="line">        future = TracebackFuture()</div><div class="line"></div><div class="line">        <span class="keyword">if</span> replace_callback <span class="keyword">and</span> <span class="string">'callback'</span> <span class="keyword">in</span> kwargs:</div><div class="line">            callback = kwargs.pop(<span class="string">'callback'</span>)</div><div class="line">            IOLoop.current().add_future(</div><div class="line">                future, <span class="keyword">lambda</span> future: callback(future.result()))</div><div class="line"></div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            result = func(*args, **kwargs)</div><div class="line">        <span class="keyword">except</span>:</div><div class="line">            <span class="string">'''省略'''</span></div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            <span class="keyword">if</span> isinstance(result, GeneratorType):</div><div class="line">                <span class="keyword">try</span>:</div><div class="line">                    orig_stack_contexts = stack_context._state.contexts</div><div class="line">                    <span class="comment">#初次调用next,获取yield返回的对象</span></div><div class="line">                    yielded = next(result)</div><div class="line">                    <span class="keyword">if</span> stack_context._state.contexts <span class="keyword">is</span> <span class="keyword">not</span> orig_stack_contexts:</div><div class="line">                        yielded = TracebackFuture()</div><div class="line">                        yielded.set_exception(</div><div class="line">                            stack_context.StackContextInconsistentError(</div><div class="line">                                <span class="string">'stack_context inconsistency (probably caused '</span></div><div class="line">                                <span class="string">'by yield within a "with StackContext" block)'</span>))</div><div class="line">                <span class="keyword">except</span> (StopIteration, Return) <span class="keyword">as</span> e:</div><div class="line">                    future.set_result(_value_from_stopiteration(e))</div><div class="line">                <span class="keyword">except</span> Exception:</div><div class="line">                    future.set_exc_info(sys.exc_info())</div><div class="line">                <span class="keyword">else</span>:</div><div class="line">                    Runner(result, future, yielded)</div><div class="line">                <span class="keyword">try</span>:</div><div class="line">                    <span class="keyword">return</span> future</div><div class="line">                <span class="keyword">finally</span>:</div><div class="line">                    future = <span class="keyword">None</span></div><div class="line">        future.set_result(result)</div><div class="line">        <span class="keyword">return</span> future</div><div class="line">    <span class="keyword">return</span> wrapper</div></pre></td></tr></table></figure>
<p><code>result</code>为直接调用函数返回的装饰器，之后调用<code>next()</code>得到的<code>yielded</code>为yield语句返回的对象。之后放入<code>Runner</code>类初始化过程中统一处理，处理完后的send()也在<code>Runner</code>类中执行。</p>
<p>Runner类<br>Runner实例化时，会调用两个重要的函数。<code>handle_yield(yielded)</code>和<code>run()</code>函数。handle_yield函数将第一次调用next()返回的yielded进行处理。handle_yield的部分代码</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">try:</div><div class="line">    #转化为Future</div><div class="line">    self<span class="selector-class">.future</span> = convert_yielded(yielded)</div><div class="line">except BadYieldError:</div><div class="line">    self<span class="selector-class">.future</span> = TracebackFuture()</div><div class="line">    self<span class="selector-class">.future</span><span class="selector-class">.set_exc_info</span>(sys.exc_info())</div><div class="line"></div><div class="line"><span class="keyword">if</span> not self<span class="selector-class">.future</span><span class="selector-class">.done</span>() or self<span class="selector-class">.future</span> is moment:</div><div class="line">    self<span class="selector-class">.io_loop</span><span class="selector-class">.add_future</span>(</div><div class="line">        self<span class="selector-class">.future</span>, lambda f: self.run())</div><div class="line">    return False</div><div class="line">return True</div></pre></td></tr></table></figure>
<p>将yielded对象转化为Future对象，然后调用add_furure()将回调函数(这里为lambda)和future对象加入ioloop调度，如果future还没执行完得到结果，则需要等<code>set_result()</code>设置result后，才会执行这个回调函数(run函数)。如果执行完得到结果<code>handle_yield()</code>返回True,否则返回False。如果返回True，则调用run()函数。来看看<code>run函数</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></div><div class="line">    <span class="string">"""Starts or resumes the generator, running until it reaches a</span></div><div class="line">    yield point that is not ready.</div><div class="line">    """</div><div class="line">    <span class="keyword">if</span> self.running <span class="keyword">or</span> self.finished:</div><div class="line">        <span class="keyword">return</span></div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        self.running = <span class="keyword">True</span></div><div class="line">        <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">            future = self.future</div><div class="line">            <span class="keyword">if</span> <span class="keyword">not</span> future.done():</div><div class="line">                <span class="keyword">return</span></div><div class="line">            self.future = <span class="keyword">None</span></div><div class="line">            <span class="keyword">try</span>:</div><div class="line">                orig_stack_contexts = stack_context._state.contexts</div><div class="line">                exc_info = <span class="keyword">None</span></div><div class="line"></div><div class="line">                <span class="keyword">try</span>:</div><div class="line">                    value = future.result()</div><div class="line">                <span class="keyword">except</span> Exception:</div><div class="line">                    self.had_exception = <span class="keyword">True</span></div><div class="line">                    exc_info = sys.exc_info()</div><div class="line"></div><div class="line">                <span class="keyword">if</span> exc_info <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</div><div class="line">                    yielded = self.gen.throw(*exc_info)</div><div class="line">                    exc_info = <span class="keyword">None</span></div><div class="line">                <span class="keyword">else</span>:</div><div class="line">                    <span class="comment">#将结果发送回</span></div><div class="line">                    yielded = self.gen.send(value)</div><div class="line"></div><div class="line">                <span class="keyword">if</span> stack_context._state.contexts <span class="keyword">is</span> <span class="keyword">not</span> orig_stack_contexts:</div><div class="line">                    self.gen.throw(</div><div class="line">                        stack_context.StackContextInconsistentError(</div><div class="line">                            <span class="string">'stack_context inconsistency (probably caused '</span></div><div class="line">                            <span class="string">'by yield within a "with StackContext" block)'</span>))</div><div class="line">            <span class="keyword">except</span>:</div><div class="line">                <span class="string">"""省略"""</span></div><div class="line">            <span class="keyword">if</span> <span class="keyword">not</span> self.handle_yield(yielded):</div><div class="line">                <span class="keyword">return</span></div><div class="line">    <span class="keyword">finally</span>:</div><div class="line">        self.running = <span class="keyword">False</span></div></pre></td></tr></table></figure>
<p>刚才说只有Future对象处理完，拿到result,才调用<code>run()</code>.<code>run()</code>中将result发送回去，比如上面例子中的response变量。</p>
<h1 id="httpserver模块分析"><a href="#httpserver模块分析" class="headerlink" title="httpserver模块分析"></a>httpserver模块分析</h1><h1 id="tornado多进程"><a href="#tornado多进程" class="headerlink" title="tornado多进程"></a>tornado多进程</h1>
      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/program/">program</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/python/">python</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/tornado/">tornado</a></li></ul>
	</div>

      

      

      
        
<div class="share-btn share-icons tooltip-left">
  <div class="tooltip tooltip-east">
    <span class="tooltip-item">
      <a href="javascript:;" class="share-sns share-outer">
        <i class="icon icon-share"></i>
      </a>
    </span>
    <span class="tooltip-content">
      <div class="share-wrap">
        <div class="share-icons">
          <a class="weibo share-sns" href="javascript:;" data-type="weibo">
            <i class="icon icon-weibo"></i>
          </a>
          <a class="weixin share-sns wxFab" href="javascript:;" data-type="weixin">
            <i class="icon icon-weixin"></i>
          </a>
          <a class="qq share-sns" href="javascript:;" data-type="qq">
            <i class="icon icon-qq"></i>
          </a>
          <a class="douban share-sns" href="javascript:;" data-type="douban">
            <i class="icon icon-douban"></i>
          </a>
          <a class="qzone share-sns" href="javascript:;" data-type="qzone">
            <i class="icon icon-qzone"></i>
          </a>
          <a class="facebook share-sns" href="javascript:;" data-type="facebook">
            <i class="icon icon-facebook"></i>
          </a>
          <a class="twitter share-sns" href="javascript:;" data-type="twitter">
            <i class="icon icon-twitter"></i>
          </a>
          <a class="google share-sns" href="javascript:;" data-type="google">
            <i class="icon icon-google"></i>
          </a>
        </div>
      </div>
    </span>
  </div>
</div>

<div class="page-modal wx-share js-wx-box">
    <a class="close js-modal-close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <div class="wx-qrcode">
      <img src="http://s.jiathis.com/qrcode.php?url=http://liuchao.site/2016/12/05/tornado学习笔记/" alt="微信分享二维码">
    </div>
</div>

<div class="mask js-mask"></div>
      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

  
<nav id="article-nav">
  
  
    <a href="/2016/12/04/Python并发编程之线程总结/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">Python并发编程之线程总结</div>
      <i class="icon-circle-right"></i>
    </a>
  
</nav>






<div class="duoshuo">
	<!-- 多说评论框 start -->
	<div class="ds-thread" data-thread-key="tornado学习笔记" data-title="tornado源码学习笔记" data-url="http://liuchao.site/2016/12/05/tornado学习笔记/"></div>
	<!-- 多说评论框 end -->
	<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"liuchaopy"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
	<!-- 多说公共JS代码 end -->
</div>





          </div>
        </div>
      </div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2017 Fantasy
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    <script>
	var yiliaConfig = {
		mathjax: true,
		animate: true,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: true,
		root: "/",
		innerArchive: true
	}
</script>

<script src="/./main.js"></script>


<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


    
<div class="tools-col" v-bind:class="{ show: isShow, hide: isShow === false }" v-on:click="stop($event)">
  <div class="tools-wrap">
    
    	<section class="tools-section tools-section-all" v-show="innerArchive">
        <div class="search-wrap">
          <input class="search-ipt" v-model="search" type="text" placeholder="find something…">
          <i class="icon-search icon" v-show="search===''"></i>
          <i class="icon-close icon" v-show="search!==''" v-on:click="clearChose($event)"></i>
        </div>
        <div class="widget tagcloud search-tag">
          <p class="search-tag-wording">tag:</p>
          <label class="search-switch">
            <input type="checkbox" v-on:click="toggleTag($event)" v-bind:checked="showTags">
          </label>
          <ul class="article-tag-list" v-bind:class="{ show: showTags }">
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" v-on:click="choseTag($event)" class="color3" style="font-size: 12px;">program</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" v-on:click="choseTag($event)" class="color3" style="font-size: 12px;">js</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" v-on:click="choseTag($event)" class="color3" style="font-size: 12px;">linux</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" v-on:click="choseTag($event)" class="color3" style="font-size: 12px;">python</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" v-on:click="choseTag($event)" class="color3" style="font-size: 12px;">django</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" v-on:click="choseTag($event)" class="color3" style="font-size: 12px;">数据结构与算法</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" v-on:click="choseTag($event)" class="color3" style="font-size: 12px;">tornado</a>
              </li>
            
            <div class="clearfix"></div>
          </ul>
        </div>
        <ul class="search-ul">
          <p v-show="jsonFail" style="padding: 20px; font-size: 12px;">
            缺失模块。<br/>1、在博客根目录（注意不是yilia根目录）执行以下命令：<br/> npm i hexo-generator-json-content --save<br/><br/>
            2、在根目录_config.yml里添加配置：
<pre style="font-size: 12px;" v-show="jsonFail">
  jsonContent:
    meta: false
    pages: false
    posts:
      title: true
      date: true
      path: true
      text: true
      raw: false
      content: false
      slug: false
      updated: false
      comments: false
      link: false
      permalink: false
      excerpt: false
      categories: false
      tags: true
</pre>
          </p>
          <li class="search-li" v-for="item in items" v-show="!item.isHide">
            <a v-bind:href="item.path|urlformat" class="search-title"><i class="icon-quo-left icon"></i>{{ item.title }}</a>
            <p class="search-time">
              <i class="icon-calendar icon"></i>
              <span>{{ item.date|dateformat }}</span>
            </p>
            <p class="search-tag">
              <i class="icon-price-tags icon"></i>
              <span v-for="tag in item.tags" v-on:click="choseTag($event, tag.name)">#{{ tag.name }}</span>
            </p>
          </li>
        </ul>
    	</section>
    

    

    
    	<section class="tools-section tools-section-me" v-show="aboutme">
  	  	
  	  		<div class="aboutme-wrap" id="js-aboutme">lala</div>
  	  	
    	</section>
    
  </div>
  
</div>
    <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>
  </div>
</body>
</html>