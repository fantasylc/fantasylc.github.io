<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <link rel="dns-prefetch" href="http://liuchao.site">
  <title>sqlalchemy学习笔记 | Fantasy的个人博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="SQLAlchemy是Python语言的一款开源软件，提供了SQL工具包和ORM工具
基本使用">
<meta property="og:type" content="article">
<meta property="og:title" content="sqlalchemy学习笔记">
<meta property="og:url" content="http://liuchao.site/2016/12/04/sqlalchemy学习笔记/index.html">
<meta property="og:site_name" content="Fantasy的个人博客">
<meta property="og:description" content="SQLAlchemy是Python语言的一款开源软件，提供了SQL工具包和ORM工具
基本使用">
<meta property="og:updated_time" content="2016-12-05T04:13:21.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="sqlalchemy学习笔记">
<meta name="twitter:description" content="SQLAlchemy是Python语言的一款开源软件，提供了SQL工具包和ORM工具
基本使用">
  
    <link rel="alternative" href="/atom.xml" title="Fantasy的个人博客" type="application/atom+xml">
  
  
  <link rel="stylesheet" href="/main.css">
  

</head>

<body>
  <div id="container" v-bind:class="{ show: isCtnShow }">
    <canvas id="anm-canvas" class="anm-canvas"></canvas>
    <div class="left-col" v-bind:class="{ show: isShow }">
      <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img src="http://7xn3wd.com1.z0.glb.clouddn.com/52d8c966e1d74080.jpg" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">Fantasy</a></h1>
		</hgroup>

		

		<nav class="header-menu">
			<ul>
			
				<li><a href="/">主页</a></li>
	        
				<li><a href="/tags/program">编程</a></li>
	        
				<li><a href="/tags/lifenote">随笔</a></li>
	        
			</ul>
		</nav>
		<nav class="header-smart-menu">
	        
    		
    			
    			<a data-idx="0" v-on:click="openSlider($event, 'innerArchive')" href="javascript:void(0)">所有文章</a>
    			
    			
            
    			
    			<a data-idx="1" v-on:click="openSlider($event, 'aboutme')" href="javascript:void(0)">关于我</a>
    			
    			
            
		</nav>
		<nav class="header-nav">
			<div class="social">
				
					<a class="github" target="_blank" href="https://github.com/liuchaopy" title="github"><i class="icon-github"></i></a>
		        
					<a class="weibo" target="_blank" href="http://weibo.com/fantasy824" title="weibo"><i class="icon-weibo"></i></a>
		        
					<a class="zhihu" target="_blank" href="https://www.zhihu.com/people/liuchaopy/activities" title="zhihu"><i class="icon-zhihu"></i></a>
		        
					<a class="douban" target="_blank" href="https://www.douban.com/people/103793003/" title="douban"><i class="icon-douban"></i></a>
		        
			</div>
		</nav>
	</header>		
</div>

    </div>
    <div class="mid-col" v-bind:class="{ show: isShow, hide: isShow === false }">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"><i class="icon-sort"></i></div>
  		<h1 class="header-author js-mobile-header hide">Fantasy</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				
					<img src="http://7xn3wd.com1.z0.glb.clouddn.com/52d8c966e1d74080.jpg" class="js-avatar">
				
			</div>
			<hgroup>
			  <h1 class="header-author">Fantasy</h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/tags/program">编程</a></li>
		        
					<li><a href="/tags/lifenote">随笔</a></li>
		        
		        
		        	<li><a href="/archives">所有文章</a></li>
		        
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/liuchaopy" title="github"><i class="icon-github"></i></a>
			        
						<a class="weibo" target="_blank" href="http://weibo.com/fantasy824" title="weibo"><i class="icon-weibo"></i></a>
			        
						<a class="zhihu" target="_blank" href="https://www.zhihu.com/people/liuchaopy/activities" title="zhihu"><i class="icon-zhihu"></i></a>
			        
						<a class="douban" target="_blank" href="https://www.douban.com/people/103793003/" title="douban"><i class="icon-douban"></i></a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div id="wrapper" class="body-wrap">
        <div class="menu-l">
          <div class="canvas-wrap">
            <canvas data-colors="#eaeaea" data-sectionHeight="100" data-contentId="js-content" id="myCanvas1" class="anm-canvas"></canvas>
          </div>
          <div id="js-content" class="content-ll">
            <article id="post-sqlalchemy学习笔记" class="article article-type-post " itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      sqlalchemy学习笔记
    </h1>
  

        <a href="/2016/12/04/sqlalchemy学习笔记/" class="archive-article-date">
  	<time datetime="2016-12-04T15:26:21.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2016-12-04</time>
</a>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>SQLAlchemy是Python语言的一款开源软件，提供了SQL工具包和ORM工具</p>
<h2 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h2><a id="more"></a>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"><span class="meta"># -*- coding:utf-8 -*-</span></div><div class="line"><span class="keyword">import</span> uuid</div><div class="line"></div><div class="line"><span class="title">from</span> sqlalchemy <span class="keyword">import</span> create_engine</div><div class="line"><span class="title">from</span> sqlalchemy <span class="keyword">import</span> Column</div><div class="line"><span class="title">from</span> sqlalchemy.types <span class="keyword">import</span> String,CHAR,BIGINT</div><div class="line"><span class="title">from</span> sqlalchemy.orm <span class="keyword">import</span> sessionmaker</div><div class="line"><span class="title">from</span> sqlalchemy.ext.declarative <span class="keyword">import</span> declarative_base</div><div class="line"></div><div class="line"><span class="type">BaseModel</span> = declarative_base()</div><div class="line"></div><div class="line"><span class="meta">#创建连接</span></div><div class="line"><span class="title">engine</span> = create_engine('mysql://root:<span class="number">2898827027</span>@localhost:<span class="number">3306</span>/test',echo=<span class="type">True</span>)</div><div class="line"></div><div class="line"><span class="meta">#创建会话，所有关于映射的操作都需要通过会话来操作</span></div><div class="line"><span class="type">DBSession</span> = sessionmaker(bind=engine)</div><div class="line"></div><div class="line"></div><div class="line"><span class="meta">#建立模型</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="type">Blog</span>(<span class="type">BaseModel</span>):</span></div><div class="line">	__tablename__ = 'blog'</div><div class="line"></div><div class="line">	id = <span class="type">Column</span>(<span class="type">CHAR(32)</span>,<span class="title">primary_key</span>=<span class="type">True</span>)</div><div class="line">	title = <span class="type">Column</span>(<span class="type">String(64)</span>,<span class="title">server_default</span>='',<span class="title">nullable</span>=<span class="type">False</span>)</div><div class="line">	text = <span class="type">Column</span>(<span class="type">String(80)</span>,<span class="title">server_default</span>='',<span class="title">nullable</span>=<span class="type">False</span>)</div><div class="line">	user = <span class="type">Column</span>(<span class="type">CHAR(32)</span>,<span class="title">index</span>=<span class="type">True</span>,<span class="title">server_default</span>='',<span class="title">nullable</span>=<span class="type">False</span>)</div><div class="line">	create = <span class="type">Column</span>(<span class="type">BIGINT</span>,<span class="title">index</span>=<span class="type">True</span>,<span class="title">server_default</span>='0',<span class="title">nullable</span>=<span class="type">False</span>)</div><div class="line"></div><div class="line"><span class="keyword">class</span> <span class="type">User</span>(<span class="type">BaseModel</span>):</div><div class="line">	__tablename__ = 'user'</div><div class="line">	id = <span class="type">Column</span>(<span class="type">CHAR(32)</span>,<span class="title">primary_key</span>=<span class="type">True</span>)</div><div class="line">	name = <span class="type">Column</span>(<span class="type">String(32)</span>,<span class="title">server_default</span>='',<span class="title">nullable</span>=<span class="type">False</span>)</div><div class="line">	username = <span class="type">Column</span>(<span class="type">String(32)</span>,<span class="title">index</span>=<span class="type">True</span>,<span class="title">server_default</span>='',<span class="title">nullable</span>=<span class="type">False</span>)</div><div class="line">	password = <span class="type">Column</span>(<span class="type">String(64)</span>,<span class="title">server_default</span>='',<span class="title">nullable</span>=<span class="type">False</span>)</div><div class="line"></div><div class="line">def init_db():</div><div class="line">    <span class="type">BaseModel</span>,metadata.create_all(<span class="title">engine</span>)</div><div class="line">def drop_db():</div><div class="line">    <span class="type">BaseModel</span>.metadata.drop_all(<span class="title">engine</span>)</div><div class="line"></div><div class="line">    #数据库添加数据</div><div class="line">    session = <span class="type">DBSession</span>()</div><div class="line">    user1 = <span class="type">User</span>(<span class="title">id</span>=<span class="title">uuid</span>.<span class="title">uuid4</span>().hex,username='pointer',password='eleme123')</div><div class="line">    user2 = <span class="type">User</span>(<span class="title">id</span>=<span class="title">uuid</span>.<span class="title">uuid4</span>().hex,username='fantasy',password='eleme456')</div><div class="line">    blog1 = <span class="type">Blog</span>(<span class="title">id</span>=<span class="title">uuid</span>.<span class="title">uuid4</span>().hex,title='the first blog',user=user1.id)</div><div class="line">    blog2 = <span class="type">Blog</span>(<span class="title">id</span>=<span class="title">uuid</span>.<span class="title">uuid4</span>().hex,title='the second blog',user=user2.id)</div><div class="line"></div><div class="line">    session.add_all([<span class="title">user1</span>,<span class="title">user2</span>,<span class="title">blog1</span>,<span class="title">blog2</span>])</div><div class="line"></div><div class="line">    #提交到数据库中</div><div class="line">    session.commit()</div><div class="line">    #提交数据库后记得关闭连接</div><div class="line">    session.close()</div></pre></td></tr></table></figure>
<p>##字段类型<br><code>Integer/BigInteger/SmallInteger</code> 整形.</p>
<p><code>Boolean</code> 布尔类型. Python 中表现为 True/False , 数据库根据支持情况, 表现为 BOOLEAN 或 SMALLINT . 实例化时可以指定是否创建约束(默认创建).</p>
<p><code>Date/DateTime/Time</code>(timezone=False)<br>日期类型, Time 和 DateTime 实例化时可以指定是否带时区信息.</p>
<p><code>Interval</code><br>时间偏差类型. 在 Python 中表现为 datetime.timedelta() , 数据库不支持此类型则存为日期.</p>
<p><code>Enum</code>(<em>enums, *</em>kw)<br>枚举类型, 根据数据库支持情况, SQLAlchemy 会使用原生支持或者使用 VARCHAR 类型附加约束的方式实现. 原生支持中涉及新类型创建, 细节在实例化时控制.</p>
<p><code>Float</code><br>浮点小数.</p>
<p><code>Numeric</code>(precision=None, scale=None, decimal_return_scale=None, …)<br>定点小数, Python 中表现为 Decimal .</p>
<p><code>LargeBinary</code>(length=None)<br>字节数据. 根据数据库实现, 在实例化时可能需要指定大小.</p>
<p><code>PickleType</code><br>Python 对象的序列化类型.</p>
<p><code>String</code> (length=None, collation=None, …)<br>字符串类型, Python 中表现为 Unicode , 数据库表现为 VARCHAR , 通常都需要指定长度.</p>
<p><code>Unicode</code><br>类似与字符串类型, 在某些数据库实现下, 会明确表示支持非 ASCII 字符. 同时输入输出也强制是 Unicode 类型.</p>
<p><code>Text</code><br>长文本类型, Python 表现为 Unicode , 数据库表现为 TEXT .</p>
<p><code>UnicodeText</code><br>参考 Unicode .</p>
<h2 id="基本查询"><a href="#基本查询" class="headerlink" title="基本查询"></a>基本查询</h2><p>###简单查询</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">session</span><span class="selector-class">.query</span>(User)<span class="selector-class">.all</span>()</div><div class="line"><span class="selector-tag">session</span><span class="selector-class">.query</span>(User.id,User.username)<span class="selector-class">.first</span>()</div><div class="line"><span class="selector-tag">session</span><span class="selector-class">.query</span>(<span class="string">'id'</span>,<span class="string">'username'</span>)<span class="selector-class">.select_from</span>(User)<span class="selector-class">.all</span>()</div></pre></td></tr></table></figure>
<p>###条件查询</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">session.query(User).filter(User.username!=&apos;lalala&apos;).all()</div><div class="line">session.query(User).filter(User.username.like(&apos;%ointe%&apos;)).first()</div><div class="line">session.query(User).filter(User.username.in_([&apos;pointer&apos;,&apos;lalala&apos;,&apos;fantasy&apos;])).all()</div><div class="line">session.query(User).filter(~User.username.in_(&apos;pointer&apos;,&apos;lalala&apos;,&apos;fantasy&apos;]))</div><div class="line">session.query(User).filter(User.username.isnot(None))    #非空</div><div class="line">session.query(User).filter(User.username==&apos;pointer&apos;,User.id.isnot(None)).all()  #And</div><div class="line">session.query(User).filter(or_(User.username==&apos;pointer&apos;,User.username==&apos;fantasy&apos;)).first()  #Or</div><div class="line">session.query(User).filter(User.username.startswith(&apos;poin&apos;)).all()</div></pre></td></tr></table></figure>
<p>###多表查询</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">session.query(Blog, User.id, User.username).filter(Blog.user == User.id).first().id</div></pre></td></tr></table></figure>
<p>###函数</p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">from sqlalchemy import <span class="function"><span class="keyword">func</span></span></div><div class="line">session.query(<span class="function"><span class="keyword">func</span>.<span class="title">count</span><span class="params">()</span>).<span class="title">select_from</span><span class="params">(User)</span>.<span class="title">scalar</span><span class="params">()</span>  #<span class="title">scalar</span>函数：返回第一个结果中的第一条记录</span></div><div class="line"><span class="meta">#楼上相当于 session.query(User).count()</span></div><div class="line">session.query(<span class="function"><span class="keyword">func</span>.<span class="title">count</span><span class="params">()</span>,<span class="title">func</span>.<span class="title">max</span><span class="params">(User.username)</span>).<span class="title">select_from</span><span class="params">(User)</span>.<span class="title">first</span><span class="params">()</span></span></div></pre></td></tr></table></figure>
<h2 id="更新"><a href="#更新" class="headerlink" title="更新"></a>更新</h2><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">session.query(<span class="keyword">User</span>).filter_by(username=<span class="string">'pointer'</span>).update(&#123;<span class="string">'username'</span>:<span class="string">'lala'</span>&#125;)</div><div class="line">session.commit()</div><div class="line"><span class="comment">#或者</span></div><div class="line"><span class="keyword">user</span> = session.query(<span class="keyword">User</span>).filter(<span class="keyword">User</span>.username==<span class="string">'pointer'</span>).first()</div><div class="line"><span class="keyword">user</span>.username = <span class="string">'lala'</span></div><div class="line">session.commit()</div></pre></td></tr></table></figure>
<p>默认情况下，这样会修改当前会话中的对象属性。如果语句中有SQL函数，或是涉及到属性原值的引用，则会报错。所以不能直接这样操作:</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">session</span><span class="selector-class">.query</span>(<span class="selector-tag">User</span>)<span class="selector-class">.update</span>(&#123;<span class="attribute">User.name</span>:func.<span class="built_in">trim</span>(<span class="string">'123   '</span>)&#125;)</div><div class="line"><span class="selector-tag">session</span><span class="selector-class">.query</span>(<span class="selector-tag">User</span>)<span class="selector-class">.update</span>(&#123;<span class="attribute">User.name</span>:User.name+<span class="string">'xx'</span>&#125;)</div></pre></td></tr></table></figure>
<p>这种情况下，就不能要求 SQLAlchemy 修改当前 session 的对象属性了, 而是直接进行数据库的交互, 不管当前会话值:</p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">session.query(User).update(&#123;User.name:<span class="function"><span class="keyword">func</span>.<span class="title">trim</span><span class="params">(<span class="string">'123   '</span>)</span>&#125;,<span class="title">synchronize_session</span>=<span class="title">False</span>)</span></div><div class="line">session.commit()</div></pre></td></tr></table></figure>
<p><code>synchronize_session</code>的默认值为<code>evaluate</code>即会修改当前session的对象属性<br><code>synchronize_session</code>为<code>False</code>时，表示不修改当前session中的对象属性，直接与数据库交互<br><code>synchronize_session</code>还可为<code>fetch</code> 表示修改前, 会先通过 select 查询条目的值</p>
<p>##删除</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">session.query(<span class="keyword">User</span>).filter_by(username=<span class="string">'fantasy'</span>).delete()</div><div class="line"><span class="comment">#或者</span></div><div class="line"><span class="keyword">user</span> = session.query(<span class="keyword">User</span>).filter_by(username=<span class="string">'fantasy'</span>).first()</div><div class="line">session.delete(<span class="keyword">user</span>)</div></pre></td></tr></table></figure>
<p> 同样需要注意synchronize_session参数问题</p>
<p>##外键</p>
<p>###一对多关系</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span>= <span class="type">Blog</span>(<span class="type">BaseModel</span>):</span></div><div class="line">    ...</div><div class="line">    user =<span class="type">Colume</span>(<span class="type">BIGINT</span>,<span class="type">ForeignKey</span>('<span class="title">user</span>.<span class="title">id'</span>),index=<span class="type">True</span>,nullable=<span class="type">False</span>)</div></pre></td></tr></table></figure>
<p>新建时：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">session = DBSession()</div><div class="line"><span class="keyword">user</span> = <span class="keyword">User</span>(name=<span class="string">'haha'</span>,username=<span class="string">'fantasy'</span>)</div><div class="line">session.add(<span class="keyword">user</span>)</div><div class="line">session.flush()  <span class="comment">#与数据库交互，但并不提交。感觉是写入了数据库内存中，但不写入数据库文件中</span></div><div class="line">blog = Blog(title=<span class="string">'I am a title'</span>,<span class="keyword">user</span>=<span class="keyword">user</span>.id)</div><div class="line">session.add(blog)</div><div class="line">session.commit()</div></pre></td></tr></table></figure>
<p>反向关系</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="title">from</span> sqlalchemy.orm <span class="keyword">import</span> relationship</div><div class="line"><span class="class"></span></div><div class="line"><span class="keyword">class</span> <span class="type">Blog</span>():</div><div class="line">    ...</div><div class="line">    user = <span class="type">Column</span>(<span class="type">BIGINT</span>)</div><div class="line">    user_obj = relationship('<span class="type">User</span>')</div><div class="line"></div><div class="line"><span class="keyword">class</span> <span class="type">User</span>():</div><div class="line">    blogs = relationship('<span class="type">Blog</span>',<span class="title">order_by</span>='<span class="type">Blog</span>.<span class="title">create'</span>,<span class="title">lazy</span>='<span class="title">dynamic'</span>)</div></pre></td></tr></table></figure>
<p>关系查询<br>一对多：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">user</span> = session.query(<span class="keyword">User</span>).filter(<span class="keyword">User</span>.blogs.any(Blog.title==<span class="string">'titititle'</span>)).first()</div></pre></td></tr></table></figure>
<p>多对一</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">blog = session.query(Blog).<span class="built_in">filter</span>(Blog.user_obj.<span class="built_in">has</span>(User.name==<span class="string">'fantasy'</span>)).<span class="keyword">first</span>()</div></pre></td></tr></table></figure>
<p>###多对多关系</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="type">Blog</span>(<span class="type">BaseModel</span>):</span></div><div class="line">    __tablename__ = 'blog'</div><div class="line"></div><div class="line">    id = <span class="type">Column</span>(<span class="type">BIGINT</span>, <span class="title">primary_key</span>=<span class="type">True</span>, <span class="title">autoincrement</span>=<span class="type">True</span>)</div><div class="line">    title = <span class="type">Column</span>(<span class="type">String(64)</span>, <span class="title">server_default</span>='', <span class="title">nullable</span>=<span class="type">False</span>)</div><div class="line"></div><div class="line">    tag_list = relationship('<span class="type">Tag</span>', <span class="title">secondary</span>=<span class="title">lambda</span>: <span class="type">BlogAndTag</span>.<span class="title">__table__</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">class</span> <span class="type">Tag</span>(<span class="type">BaseModel</span>):</div><div class="line">    __tablename__ = 'tag'</div><div class="line"></div><div class="line">    id = <span class="type">Column</span>(<span class="type">BIGINT</span>, <span class="title">primary_key</span>=<span class="type">True</span>, <span class="title">autoincrement</span>=<span class="type">True</span>)</div><div class="line">    name = <span class="type">Column</span>(<span class="type">String(16)</span>, <span class="title">server_default</span>='', <span class="title">nullable</span>=<span class="type">False</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">class</span> <span class="type">BlogAndTag</span>(<span class="type">BaseModel</span>):</div><div class="line">    __tablename__ = 'blog_and_tag'</div><div class="line"></div><div class="line">    id = <span class="type">Column</span>(<span class="type">BIGINT</span>, <span class="title">primary_key</span>=<span class="type">True</span>, <span class="title">autoincrement</span>=<span class="type">True</span>)</div><div class="line">    blog = <span class="type">Column</span>(<span class="type">BIGINT</span>, <span class="type">ForeignKey</span>('<span class="title">blog</span>.<span class="title">id'</span>), index=<span class="type">True</span>)</div><div class="line">    tag = <span class="type">Column</span>(<span class="type">BIGINT</span>, <span class="type">ForeignKey</span>('<span class="title">tag</span>.<span class="title">id'</span>), index=<span class="type">True</span>)</div><div class="line">    create = <span class="type">Column</span>(<span class="type">BIGINT</span>, <span class="title">index</span>=<span class="type">True</span>, <span class="title">server_default</span>='0')</div></pre></td></tr></table></figure>
<p>###新建和删除</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">session = DBSession()</div><div class="line">blog = session.query(Blog).<span class="built_in">filter</span>(Blog.title==<span class="string">'titititle'</span>).<span class="keyword">first</span>()</div><div class="line"><span class="keyword">tag</span> = Tag(name=<span class="string">'python'</span>)</div><div class="line">blog.tag_list = [<span class="keyword">tag</span>]</div><div class="line">session.<span class="built_in">add</span>(blog)</div><div class="line">session.commit()</div><div class="line"></div><div class="line"><span class="keyword">tag</span> = session.query(Tag).<span class="built_in">filter</span>(Tag.name==<span class="string">'python'</span>).<span class="keyword">first</span>()</div><div class="line">blog.tag_list.<span class="built_in">remove</span>(<span class="keyword">tag</span>)</div><div class="line">session.<span class="keyword">delete</span>(<span class="keyword">tag</span>)</div><div class="line">session.commit()</div></pre></td></tr></table></figure>
<p>###属性代理<br>一般我们关联的是某个模型对象，但有时候我们我们并不关心整个模型对象，而只是模型对象的某个属性。便可以这样：</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="title">from</span> sqlalchemy.ext.associationproxy <span class="keyword">import</span> association_proxy</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="type">Blog</span>():</span></div><div class="line">    ...</div><div class="line">    user = <span class="type">Column</span>(<span class="type">Integer</span>,<span class="type">ForeignKey</span>('<span class="title">user</span>.<span class="title">id'</span>),index=<span class="type">True</span>)</div><div class="line">    user_obj = relationship('<span class="type">User</span>')</div><div class="line">    user_name = association_proxy('<span class="title">user_obj'</span>,'<span class="title">username'</span>,<span class="title">creator</span>=<span class="title">lambda</span> <span class="title">name</span>:<span class="type">User</span>(<span class="title">username</span>=<span class="title">name</span>))</div><div class="line">    </div><div class="line">    def __init__(<span class="title">self</span>,<span class="title">title</span>):</div><div class="line">        self.title = title     #注意如果没有这个，不能直接对属性进行设置或创建。</div><div class="line">    </div><div class="line"><span class="keyword">class</span> <span class="type">User</span>():</div><div class="line">    ...</div><div class="line">    blog_list = relationship('<span class="type">Blog</span>')</div><div class="line">    blog_title_list = association_proxy('<span class="title">blog_list'</span>,'<span class="title">title'</span>)</div><div class="line"></div><div class="line"></div><div class="line">session = <span class="type">DBSession</span>()</div><div class="line">user = <span class="type">User</span>(<span class="title">name</span>='<span class="title">xxx'</span>)</div><div class="line">user.blog_list = [<span class="type">Blog</span>(<span class="title">title</span>='<span class="type">ABC</span>')]</div><div class="line">session.add(<span class="title">user</span>)</div><div class="line">session.commit()</div><div class="line"></div><div class="line">user = session.query(<span class="type">User</span>).first()</div><div class="line">print user.blog_title_list</div></pre></td></tr></table></figure>
<p>查询：<br>多对一：</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">blog = session.query(Blog.username==<span class="string">'lala'</span>).<span class="keyword">first</span>()</div><div class="line"></div><div class="line">一对多：</div><div class="line"></div><div class="line">user = session.query(User).<span class="built_in">filter</span>(User.blog_title_list.<span class="keyword">contains</span>(<span class="string">'lala'</span>)).<span class="keyword">first</span>()</div></pre></td></tr></table></figure>
<p>##会话与事务控制</p>
<p>###基本使用</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">try</span>:</div><div class="line">    user = session.Query(User).first()</div><div class="line">    user.name = u'改名字</div><div class="line">    session.commit()</div><div class="line">except:</div><div class="line">    session.rollback()</div></pre></td></tr></table></figure>
<p>###事务嵌套：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">session</span><span class="selector-class">.add</span>(<span class="selector-tag">u1</span>)</div><div class="line"><span class="selector-tag">session</span><span class="selector-class">.add</span>(<span class="selector-tag">u2</span>)</div><div class="line"></div><div class="line"><span class="selector-tag">session</span><span class="selector-class">.begin_nested</span>()</div><div class="line"><span class="selector-tag">session</span><span class="selector-class">.add</span>(<span class="selector-tag">u3</span>)</div><div class="line"><span class="selector-tag">session</span><span class="selector-class">.rollback</span>() # <span class="selector-tag">rolls</span> <span class="selector-tag">back</span> <span class="selector-tag">u3</span>, <span class="selector-tag">keeps</span> <span class="selector-tag">u1</span> <span class="selector-tag">and</span> <span class="selector-tag">u2</span></div><div class="line"></div><div class="line"><span class="selector-tag">session</span><span class="selector-class">.commit</span>()</div></pre></td></tr></table></figure>
<p>注意事务嵌套中，最外层事务提交整个变更才会生效</p>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/program/">program</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/python/">python</a></li></ul>
	</div>

      

      

      
        
<div class="share-btn share-icons tooltip-left">
  <div class="tooltip tooltip-east">
    <span class="tooltip-item">
      <a href="javascript:;" class="share-sns share-outer">
        <i class="icon icon-share"></i>
      </a>
    </span>
    <span class="tooltip-content">
      <div class="share-wrap">
        <div class="share-icons">
          <a class="weibo share-sns" href="javascript:;" data-type="weibo">
            <i class="icon icon-weibo"></i>
          </a>
          <a class="weixin share-sns wxFab" href="javascript:;" data-type="weixin">
            <i class="icon icon-weixin"></i>
          </a>
          <a class="qq share-sns" href="javascript:;" data-type="qq">
            <i class="icon icon-qq"></i>
          </a>
          <a class="douban share-sns" href="javascript:;" data-type="douban">
            <i class="icon icon-douban"></i>
          </a>
          <a class="qzone share-sns" href="javascript:;" data-type="qzone">
            <i class="icon icon-qzone"></i>
          </a>
          <a class="facebook share-sns" href="javascript:;" data-type="facebook">
            <i class="icon icon-facebook"></i>
          </a>
          <a class="twitter share-sns" href="javascript:;" data-type="twitter">
            <i class="icon icon-twitter"></i>
          </a>
          <a class="google share-sns" href="javascript:;" data-type="google">
            <i class="icon icon-google"></i>
          </a>
        </div>
      </div>
    </span>
  </div>
</div>

<div class="page-modal wx-share js-wx-box">
    <a class="close js-modal-close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <div class="wx-qrcode">
      <img src="http://s.jiathis.com/qrcode.php?url=http://liuchao.site/2016/12/04/sqlalchemy学习笔记/" alt="微信分享二维码">
    </div>
</div>

<div class="mask js-mask"></div>
      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

  
<nav id="article-nav">
  
    <a href="/2016/12/04/Ajax提交Form登陆表单遇到的小坑/" id="article-nav-newer" class="article-nav-link-wrap">
      <i class="icon-circle-left"></i>
      <div class="article-nav-title">
        
          Ajax提交Form登陆表单遇到的小坑
        
      </div>
    </a>
  
  
    <a href="/2016/12/04/图的深度优先和广度优先遍历-Python实现/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">图的深度优先和广度优先遍历-Python实现</div>
      <i class="icon-circle-right"></i>
    </a>
  
</nav>






<div class="duoshuo">
	<!-- 多说评论框 start -->
	<div class="ds-thread" data-thread-key="sqlalchemy学习笔记" data-title="sqlalchemy学习笔记" data-url="http://liuchao.site/2016/12/04/sqlalchemy学习笔记/"></div>
	<!-- 多说评论框 end -->
	<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"liuchaopy"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
	<!-- 多说公共JS代码 end -->
</div>





          </div>
        </div>
      </div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2017 Fantasy
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    <script>
	var yiliaConfig = {
		mathjax: true,
		animate: true,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: true,
		root: "/",
		innerArchive: true
	}
</script>

<script src="/./main.js"></script>


<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


    
<div class="tools-col" v-bind:class="{ show: isShow, hide: isShow === false }" v-on:click="stop($event)">
  <div class="tools-wrap">
    
    	<section class="tools-section tools-section-all" v-show="innerArchive">
        <div class="search-wrap">
          <input class="search-ipt" v-model="search" type="text" placeholder="find something…">
          <i class="icon-search icon" v-show="search===''"></i>
          <i class="icon-close icon" v-show="search!==''" v-on:click="clearChose($event)"></i>
        </div>
        <div class="widget tagcloud search-tag">
          <p class="search-tag-wording">tag:</p>
          <label class="search-switch">
            <input type="checkbox" v-on:click="toggleTag($event)" v-bind:checked="showTags">
          </label>
          <ul class="article-tag-list" v-bind:class="{ show: showTags }">
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" v-on:click="choseTag($event)" class="color3" style="font-size: 12px;">program</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" v-on:click="choseTag($event)" class="color3" style="font-size: 12px;">js</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" v-on:click="choseTag($event)" class="color3" style="font-size: 12px;">linux</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" v-on:click="choseTag($event)" class="color3" style="font-size: 12px;">python</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" v-on:click="choseTag($event)" class="color3" style="font-size: 12px;">django</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" v-on:click="choseTag($event)" class="color3" style="font-size: 12px;">数据结构与算法</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" v-on:click="choseTag($event)" class="color3" style="font-size: 12px;">tornado</a>
              </li>
            
            <div class="clearfix"></div>
          </ul>
        </div>
        <ul class="search-ul">
          <p v-show="jsonFail" style="padding: 20px; font-size: 12px;">
            缺失模块。<br/>1、在博客根目录（注意不是yilia根目录）执行以下命令：<br/> npm i hexo-generator-json-content --save<br/><br/>
            2、在根目录_config.yml里添加配置：
<pre style="font-size: 12px;" v-show="jsonFail">
  jsonContent:
    meta: false
    pages: false
    posts:
      title: true
      date: true
      path: true
      text: true
      raw: false
      content: false
      slug: false
      updated: false
      comments: false
      link: false
      permalink: false
      excerpt: false
      categories: false
      tags: true
</pre>
          </p>
          <li class="search-li" v-for="item in items" v-show="!item.isHide">
            <a v-bind:href="item.path|urlformat" class="search-title"><i class="icon-quo-left icon"></i>{{ item.title }}</a>
            <p class="search-time">
              <i class="icon-calendar icon"></i>
              <span>{{ item.date|dateformat }}</span>
            </p>
            <p class="search-tag">
              <i class="icon-price-tags icon"></i>
              <span v-for="tag in item.tags" v-on:click="choseTag($event, tag.name)">#{{ tag.name }}</span>
            </p>
          </li>
        </ul>
    	</section>
    

    

    
    	<section class="tools-section tools-section-me" v-show="aboutme">
  	  	
  	  		<div class="aboutme-wrap" id="js-aboutme">lala</div>
  	  	
    	</section>
    
  </div>
  
</div>
    <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>
  </div>
</body>
</html>